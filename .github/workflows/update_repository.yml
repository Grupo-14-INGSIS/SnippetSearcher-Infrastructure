name: Deploy to VM

permissions:
  contents: read
  packages: read

on:
  push:

jobs:
  update:
    runs-on: ubuntu-latest
    environment: develop
    steps:
      - name: Checkout infrastructure repository
        uses: actions/checkout@v4

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          VM_DIRECTORY: ${{ secrets.SSH_DIRECTORY || 'SnippetSearcher-Infrastructure' }}
          BRANCH: ${{ github.ref_name }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GITHUB_TOKEN,GITHUB_ACTOR,VM_DIRECTORY,BRANCH
          script: |
            set -e
            
            echo "Navigating to project directory"
            cd $VM_DIRECTORY
            
            echo "Checking for updates"
            git fetch origin
            LOCAL=$(git rev-parse HEAD)
            REMOTE=$(git rev-parse origin/$BRANCH)
            
            echo "Saving current commit"
            LAST_SAFE_COMMIT=$(git rev-parse HEAD)
            echo "Current commit: $LAST_SAFE_COMMIT"
            
            if [ "$LOCAL" = "$REMOTE" ]; then
              echo "Already up to date. Skipping deployment."
              exit 0
            fi
            
            echo "Pulling latest changes from repository"
            git pull
            
            echo "Stopping containers"
            docker compose down
            
            echo "Logging in to GitHub Container Registry"
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
            
            echo "Pulling latest images"
            docker compose pull
            
            echo "Starting containers"
            docker compose up -d
            
            echo "Waiting for containers to be healthy"
            sleep 30
            
            echo "Checking container health"
            if docker compose ps | grep -q "unhealthy\|Exited"; then
              echo ""
              echo "######################################################"
              echo "###  SOME CONTAINERS WERE UNHEALTHY. ROLLING BACK  ###"
              echo "######################################################"
              echo ""
              git reset --hard $LAST_SAFE_COMMIT
              docker compose down
              docker compose up -d
              echo "ROLLBACK COMPLETED"
              exit 1
            fi
            
            echo "Cleaning up unused images"
            docker image prune -af
            
            echo "Deployment completed successfully"
            echo ""
            echo "Container status:"
            docker compose ps