name: Build & Deploy

permissions:
  contents: read
  packages: write

on:
  repository_dispatch:
    types: [new-image-ready]

jobs:
  update:
    name: Deploy to ${{ github.event.client_payload.environment }}
    environment: ${{ github.event.client_payload.environment }}
    runs-on: ubuntu-latest
    steps:

      - name: Get service and environment from payload
        id: payload
        run: |
          SERVICE_NAME="${{ github.event.client_payload.service }}"
          ENV_NAME="${{ github.event.client_payload.environment }}"
          
          if [ -z "$SERVICE_NAME" ] || [ -z "$ENV_NAME" ]; then
            echo "Error: Missing service or environment in payload"
            exit 1
          fi
          
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "environment_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "Received request to deploy service: $SERVICE_NAME to environment: $ENV_NAME"

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SERVICE_NAME: ${{ steps.payload.outputs.service }}
          ENV_NAME: ${{ steps.validate.outputs.environment }}
          USER: ${{ github.repository_owner }}
          VM_DIRECTORY: ${{ secrets.SSH_DIRECTORY || 'SnippetSearcher-Infrastructure' }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GITHUB_TOKEN,SERVICE_NAME,ENV_NAME,USER,VM_DIRECTORY
          script: |
            set -e
            
            cd $VM_DIRECTORY
            
            echo "--- Logging into GHCR ---"
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u $USER --password-stdin

            echo "--- Pulling new image for $SERVICE_NAME ---"
            docker compose pull $SERVICE_NAME

            echo "--- Restarting container for $SERVICE_NAME ---"
            docker compose up -d --no-deps --force-recreate $SERVICE_NAME
            
            echo "--- Pruning old images ---"
            docker image prune -f
            
            echo "--- Verify running containers ---"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"