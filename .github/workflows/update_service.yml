name: Build & Deploy

permissions:
  contents: read
  packages: read

on:
  repository_dispatch:
    types: [new-image-ready]

jobs:
  update:
    name: Deploy to ${{ github.event.client_payload.environment }}
    # Elige el entorno (y sus secrets) basado en el payload del evento
    environment: ${{ github.event.client_payload.environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Get service and environment from payload
        id: payload
        run: |
          SERVICE_NAME="${{ github.event.client_payload.service }}"
          ENV_NAME="${{ github.event.client_payload.environment }}"
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "environment_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "Received request to deploy service: $SERVICE_NAME to environment: $ENV_NAME"

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Estos secrets ahora vienen del entorno seleccionado
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Asumimos que esta ruta es la misma en ambas VMs
            # Si no, necesitaremos otra variable para la ruta.
            cd /home/azureuser/SnippetSearcher-Infrastructure
            
            # El resto de los comandos se ejecutan en tu VM
            echo "--- Logging into GHCR ---"
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

            echo "--- Pulling new image for ${{ steps.payload.outputs.service_name }} ---"
            docker compose pull ${{ steps.payload.outputs.service_name }}:${{ steps.payload.outputs.environment }}

            echo "--- Restarting container for ${{ steps.payload.outputs.service_name }} ---"
            docker compose up -d --no-deps ${{ steps.payload.outputs.service_name }}:${{ steps.payload.outputs.environment }}
            
            echo "--- Pruning old images ---"
            docker image prune -f
            
            echo "--- Verify running containers ---"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"