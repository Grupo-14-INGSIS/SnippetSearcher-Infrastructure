name: Build & Deploy

permissions:
  contents: read
  packages: read

on:
  repository_dispatch:
    types: [new-image-ready]

jobs:
  update:
    runs-on: self-hosted #ya puede funcionar tanto para el actions-runner de dev asÃ­ como para el de prod
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log-in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get service from payload
        id: payload
        run: |
          SERVICE_NAME="${{ github.event.client_payload.service }}"
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "Received request to deploy service: $SERVICE_NAME"

      - name: Pull image for ${{ steps.payload.outputs.service_name }}
        run: docker compose pull ${{ steps.payload.outputs.service_name }}

      - name: Restart container for ${{ steps.payload.outputs.service_name }}
        run: docker compose up -d --no-deps ${{ steps.payload.outputs.service_name }}

      - name: Show logs on failure
        if: failure()
        run: docker compose logs --tail=100

      - name: Verify running containers
        run: docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
      - name: Prune old images
        run: docker image prune -f